name: Patch Check

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  apply-and-lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout superproject
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Ensure Shell tooling
        run: |
          sudo apt-get update -y
          sudo apt-get install -y shellcheck shfmt

      - name: Apply patches onto codex
        run: |
          chmod +x scripts/patch-apply.sh
          ./scripts/patch-apply.sh

      - name: Lint shell
        run: |
          if compgen -G "*.sh" >/dev/null; then shellcheck -S style ./*.sh || true; fi
          if compgen -G "scripts/*.sh" >/dev/null; then shellcheck -S style scripts/*.sh || true; fi
          if compgen -G "patches/**/*.sh" >/dev/null; then shellcheck -S style patches/**/*.sh || true; fi

      - name: Format shell (check)
        run: |
          if compgen -G "*.sh" >/dev/null; then shfmt -d -i 2 -ci ./*.sh || true; fi
          if compgen -G "scripts/*.sh" >/dev/null; then shfmt -d -i 2 -ci scripts/*.sh || true; fi
