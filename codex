#!/usr/bin/env bash
# codex wrapper adds an optional auto-update layer before delegating to the real binary.
set -euo pipefail

SCRIPT_SOURCE="${BASH_SOURCE[0]:-$0}"
SCRIPT_DIR="$(cd -- "$(dirname "${SCRIPT_SOURCE}")" && pwd)"

load_env_file() {
  local candidate=""
  if [[ -n ${CODEX_ENV_FILE:-} && -r ${CODEX_ENV_FILE} ]]; then
    candidate="${CODEX_ENV_FILE}"
  elif [[ -r "$HOME/.config/codex-updater/.env" ]]; then
    candidate="$HOME/.config/codex-updater/.env"
  elif [[ -r "$SCRIPT_DIR/.env" ]]; then
    candidate="$SCRIPT_DIR/.env"
  fi
  if [[ -n $candidate ]]; then
    set -a
    # shellcheck disable=SC1090
    source "$candidate"
    set +a
  fi
}

load_env_file

UPDATER_DEFAULT="$HOME/.local/bin-core/codex-updater"
REAL_BIN_DEFAULT="$HOME/.local/bin/codex"
DEV_WORKSPACE_CANDIDATE="$HOME/development/codex-updater"
DEV_WORKSPACE=""
if [[ -d "$DEV_WORKSPACE_CANDIDATE/vendor/codex" ]]; then
  DEV_WORKSPACE="$DEV_WORKSPACE_CANDIDATE"
fi
if [[ -x "$DEV_WORKSPACE_CANDIDATE/codex-updater" ]]; then
  UPDATER_DEFAULT="$DEV_WORKSPACE_CANDIDATE/codex-updater"
fi
STATE_DIR="$HOME/.local/share/codex-wrapper"
STAMP_FILE="$STATE_DIR/last-update"
LOG_DIR="$HOME/logs"
LOG_FILE="$LOG_DIR/codex-wrapper.log"
DIST_DIR="$STATE_DIR/dist"
META_FILE="$STATE_DIR/build-info"
TIMESTAMP_FORMAT="%Y-%m-%dT%H:%M:%S%z"

UPDATER="${CODEX_UPDATER:-$UPDATER_DEFAULT}"
REAL_BIN="${CODEX_BIN:-$REAL_BIN_DEFAULT}"
AUTO_INTERVAL="${CODEX_WRAPPER_AUTO_INTERVAL:-86400}"
AUTO_PREF="${CODEX_WRAPPER_AUTO_UPDATE:-1}"
ALWAYS_UPDATE_DEFAULT_RAW="${CODEX_WRAPPER_ALWAYS_UPDATE:-0}"
USE_DEV_WORKSPACE_RAW="${CODEX_WRAPPER_USE_DEV_WORKSPACE:-0}"

case "${ALWAYS_UPDATE_DEFAULT_RAW,,}" in
  0 | false | off | no)
    ALWAYS_UPDATE_DEFAULT=0
    ;;
  *)
    ALWAYS_UPDATE_DEFAULT=1
    ;;
esac

case "${USE_DEV_WORKSPACE_RAW,,}" in
  1 | true | on | yes)
    USE_DEV_WORKSPACE=1
    ;;
  *)
    USE_DEV_WORKSPACE=0
    ;;
esac

declare -a UPDATER_ENV_VARS=()

BUILD_COMMIT=""
BUILD_VERSION=""
BUILD_BUILT_AT=""
BUILD_BRANCH=""
BUILD_REPO=""

log_err() {
  printf '[codex-wrapper] %s\n' "$*" >&2
}

log_event() {
  mkdir -p "$LOG_DIR"
  printf '%s | %s\n' "$(date +"$TIMESTAMP_FORMAT")" "$*" >>"$LOG_FILE"
}

usage() {
  cat <<'USAGE'
Usage: codex [--wrapper-update] [--wrapper-rebuild] [--wrapper-no-update] [codex-args...]

Wrapper flags:
  --wrapper-update       run the codex updater before launching.
  --wrapper-rebuild      updater with --force-rebuild.
  --wrapper-no-update    skip auto-update even if requested via env.
  --wrapper-help         show this help text.
  --wrapper-print-target print the delegated binary path and exit.
  --wrapper-version      print cached build information and exit.

Environment knobs:
  CODEX_UPDATER                 override updater path.
  CODEX_BIN                     override delegated codex binary path.
  CODEX_WRAPPER_AUTO_UPDATE=0   disable interval-based background updates (default on, 24h cadence).
  CODEX_WRAPPER_AUTO_INTERVAL   seconds between background updates (default 86400).
  CODEX_WRAPPER_ALWAYS_UPDATE   force updater before every launch (default 0; set 1 to enable).
  CODEX_WRAPPER_USE_DEV_WORKSPACE=1 opt-in to build from ~/development/codex-updater (default off).
USAGE
}

read_build_metadata() {
  BUILD_COMMIT=""
  BUILD_VERSION=""
  BUILD_BUILT_AT=""
  BUILD_BRANCH=""
  BUILD_REPO=""
  if [[ ! -f "$META_FILE" ]]; then
    return 1
  fi
  while IFS='=' read -r key value; do
    case "$key" in
      commit) BUILD_COMMIT="$value" ;;
      version) BUILD_VERSION="$value" ;;
      built_at) BUILD_BUILT_AT="$value" ;;
      branch) BUILD_BRANCH="$value" ;;
      repo) BUILD_REPO="$value" ;;
    esac
  done <"$META_FILE"
  [[ -n "$BUILD_COMMIT" || -n "$BUILD_VERSION" ]]
}

print_build_metadata() {
  if read_build_metadata; then
    local when="unknown"
    if [[ -n "$BUILD_BUILT_AT" ]]; then
      if when="$(date -u -d "@$BUILD_BUILT_AT" +%Y-%m-%dT%H:%M:%SZ 2>/dev/null)"; then
        :
      elif when="$(date -u -r "$BUILD_BUILT_AT" +%Y-%m-%dT%H:%M:%SZ 2>/dev/null)"; then
        :
      else
        when="$BUILD_BUILT_AT"
      fi
    fi
    printf 'codex version: %s\n' "${BUILD_VERSION:-unknown}"
    printf 'commit:        %s\n' "${BUILD_COMMIT:-unknown}"
    printf 'branch:        %s\n' "${BUILD_BRANCH:-unknown}"
    printf 'source repo:   %s\n' "${BUILD_REPO:-unknown}"
    printf 'built at:      %s\n' "$when"
    if [[ -f "$DIST_DIR/latest" || -d "$DIST_DIR" ]]; then
      printf 'dist dir:      %s\n' "$DIST_DIR"
    fi
  else
    printf 'No build metadata recorded yet.\n'
  fi
}

run_updater() {
  if [[ ! -x "$UPDATER" ]]; then
    log_err "Updater not found at $UPDATER"
    return 1
  fi

  mkdir -p "$STATE_DIR"
  log_event "updater start: $UPDATER $*"
  if ((${#UPDATER_ENV_VARS[@]})); then
    env "${UPDATER_ENV_VARS[@]}" "$UPDATER" "$@"
    rc=$?
  else
    "$UPDATER" "$@"
    rc=$?
  fi
  if [[ $rc -eq 0 ]]; then
    log_event "updater success"
    if read_build_metadata; then
      log_event "build metadata: version=${BUILD_VERSION:-unknown} commit=${BUILD_COMMIT:0:12}"
    fi
    date +%s >"$STAMP_FILE"
  else
    log_event "updater failure rc=$rc"
    return "$rc"
  fi
}

maybe_auto_update() {
  local skip="$1"
  shift || true
  local -a updater_args=("$@")

  if [[ "$skip" == "1" ]]; then
    return 0
  fi

  if [[ "$AUTO_PREF" != "1" ]]; then
    return 0
  fi

  if [[ ! -f "$STAMP_FILE" ]]; then
    run_updater "${updater_args[@]}"
    return $?
  fi

  local last
  if ! last=$(<"$STAMP_FILE"); then
    run_updater "${updater_args[@]}"
    return $?
  fi

  local now
  now=$(date +%s)
  if [[ $((now - last)) -ge "$AUTO_INTERVAL" ]]; then
    run_updater "${updater_args[@]}"
  fi
}

main() {
  mkdir -p "$STATE_DIR" "$DIST_DIR"

  local run_update=$ALWAYS_UPDATE_DEFAULT
  local skip_auto=0
  declare -a updater_args=()
  declare -a codex_args=()

  UPDATER_ENV_VARS=()
  if [[ -z ${CODEX_SKIP_BUILD_DEPS+x} ]]; then
    UPDATER_ENV_VARS+=("CODEX_SKIP_BUILD_DEPS=1")
  fi
  if [[ -z ${CODEX_WORKSPACE+x} && $USE_DEV_WORKSPACE -eq 1 && -n ${DEV_WORKSPACE:-} ]]; then
    UPDATER_ENV_VARS+=("CODEX_WORKSPACE=$DEV_WORKSPACE")
    if [[ -z ${CODEX_WORKSPACE_SYNC+x} ]]; then
      UPDATER_ENV_VARS+=("CODEX_WORKSPACE_SYNC=0")
    fi
  fi

  while (($#)); do
    case "$1" in
      --wrapper-update)
        run_update=1
        ;;
      --wrapper-rebuild)
        run_update=1
        updater_args+=(--force-rebuild)
        ;;
      --wrapper-no-update)
        skip_auto=1
        run_update=0
        ;;
      --wrapper-help)
        usage
        return 0
        ;;
      --wrapper-print-target)
        printf '%s\n' "$REAL_BIN"
        return 0
        ;;
      --wrapper-version)
        print_build_metadata
        return 0
        ;;
      --)
        shift
        codex_args+=("$@")
        break
        ;;
      *)
        codex_args+=("$1")
        ;;
    esac
    shift || true
  done

  if [[ ! -x "$REAL_BIN" ]]; then
    log_err "Missing codex binary at $REAL_BIN; running updater"
    run_update=1
  fi

  if [[ ${CODEX_WRAPPER_ALLOW_SUDO:-0} != 1 ]]; then
    updater_args+=(--no-sudo)
  fi

  if ((run_update)); then
    printf '[codex-wrapper] running updater before launch (set CODEX_WRAPPER_ALWAYS_UPDATE=1 to force this every time)\n' >&2
    run_updater "${updater_args[@]}"
  else
    maybe_auto_update "$skip_auto" "${updater_args[@]}"
  fi

  if [[ ! -x "$REAL_BIN" ]]; then
    log_err "codex binary still missing at $REAL_BIN"
    return 127
  fi

  exec "$REAL_BIN" "${codex_args[@]}"
}

main "$@"
